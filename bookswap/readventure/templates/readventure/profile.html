{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY PROFILE</title>
    <link rel="stylesheet" href="{% static 'css/profile.css' %}">
    <link rel="icon" href="{% static 'icon/favicon.ico' %}">
    <script>
        document.addEventListener('DOMContentLoaded', function () {
        var savebutton = document.getElementById('savebutton');
        var readonly = true;
        var inputs = document.querySelectorAll('.forms input[type="text"]');
        var profilePictureInput = document.getElementById('profilePictureInput');
        var profilePicture = document.getElementById('profilePicture');

        savebutton.addEventListener('click', function () {
            // Toggle read-only attribute for text inputs
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].toggleAttribute('readonly');
            }
            // Toggle disabled attribute for profile picture input
            profilePictureInput.toggleAttribute('disabled');

            // Change button text
            if (savebutton.innerHTML == "edit") {
                savebutton.innerHTML = "save";
            } else {
                savebutton.innerHTML = "edit";
                
                // If 'save' button clicked, update user information
                updateUserInfo();
            }
        });

        profilePictureInput.addEventListener('change', function (event) {
            // Update profile picture preview
            var file = event.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    profilePicture.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        function updateUserInfo() {
            // Get updated values from the inputs
            var firstName = document.querySelector('.inputs input[name="first_name"]').value;
            var lastName = document.querySelector('.inputs input[name="last_name"]').value;
            var email = document.querySelector('.inputs input[name="email"]').value;
            var contactNo = document.querySelector('.inputs input[name="contact_no"]').value;

            // Make an AJAX request to update user information
            fetch('{% url "save_profile" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    first_name: firstName,
                    last_name: lastName,
                    email: email,
                    contact_no: contactNo,
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('User information updated:', data);
                // You can add additional logic or UI updates if needed
            })
            .catch(error => {
                console.error('Error updating user information:', error);
            });
        }

        // Function to get CSRF token from cookies
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Check if cookie name matches the requested name
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });

    </script>
</head>
<body>
    <header>
        <nav><a href="{% url 'home' %}" style="font-size: 32px;">ReadVenture</a></nav>
        <nav>
            <a href="{% url 'home' %}">HOME</a>
            <a href="{% url 'mybooks' %}">MY BOOKS</a>
            <a href="{% url 'wishlist' %}">WISHLIST</a>
            <a href="{% url 'borrowed' %}">BORROWED</a>
            <a href="{% url 'requests' %}">REQUESTS</a>
            <a href="{% url 'profile' %}" style="color: rgb(217, 196, 255);">PROFILE</a>
            <a href="{% url 'logout' %}">LOGOUT</a>
        </nav>
    </header>

    <div class="container" style="background-image: url(/static/images/m.jpg);">
        <div class="card" style="background-color:rgba(96, 238, 191, 0.491);">
            <div class="info" style="background-color: rgb(32, 118, 118);">
                <span>Profile Info</span>
                <button id="savebutton">edit</button>
            </div>
            <div class="content">
                <div class="forms">
                    <!-- Existing form inputs go here -->
                    <div class="inputs">
                        <span><b>First Name</b></span>
                        <input type="text" readonly value="{{ user.first_name }}">
                    </div>
                    <div class="inputs">
                        <span><b>Last Name</b></span>
                        <input type="text" readonly value="{{ user.last_name }}">
                    </div>
                    <div class="inputs">
                        <span><b>Email</b></span>
                        <input type="email" readonly value="{{ user.email }}">
                    </div>
                    <div class="inputs">
                        <span><b>Student ID</b></span>
                        <input type="text" readonly value="{{ user.student_id }}">
                    </div>
                    <div class="inputs">
                        <span><b>Contact No.</b></span>
                        <input type="text" readonly value="{{ user.contact_no }}">
                    </div>                    
                </div>
                <div class="image-container">
                    <div class="inputs">
                        <span>Profile Picture</span>
                        {% if user.profile_picture %}
                            <img id="profilePicture" src="{{ user.profile_picture.url }}" alt="Profile Picture" style="max-width: 100%; height: auto; border-radius: 5px;">
                        {% else %}
                            <img id="profilePicture" src="{% static 'images/profile.jpg' %}" alt="Default Profile Picture" style="max-width: 100%; height: auto; border-radius: 5px;">
                        {% endif %}
                        <div id="profilePictureInput" class="file-input-container">
                            <input type="file" id="fileInput" accept="image/*" class="file-input" />
                            <label for="fileInput" class="file-label">Update Photo</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
